# 飞书审批事件+自动化

> 在企业中，这样的需求十分常见：审批流程结束后，**触发一个自动化动作**，比如修改某个系统的数据库记录，自动设置提醒事项等等。这能较大地提升工作效率，减少人力重复劳动。
>
> 目前市场上的办公软件多种多样，有的公司使用OA作为办公系统，有的使用IM（Instant Messaging，即时通讯）软件，本文以**飞书**为例介绍原理。
>
> 需要指出的是，审批结束后，能够**“+”**的自动化流程是最灵活的地方，可以尽情发挥想象力（只要对接的系统有接口）。

***

总体来说，整个实现过程分为两部分：

一是审批事件的发送、接收和处理；二是“+”号后面的自动化动作。

涉及三个系统和三个步骤：

（1）流程发送信号、（2）开发者接收、处理事件（3）调用执行被操作系统的API。

|      |      系统      |           解释           |       动作       |
| :--: | :------------: | :----------------------: | :--------------: |
|  1   |    办公系统    |     飞书，企微，OA等     | 发送审批事件信号 |
|  2   |  事件处理系统  |   用户服务器，代码脚本   |  接收，处理事件  |
|      |                |            +             |                  |
|  3   | 自动化执行系统 | （办公）系统数据增删改查 |     API调用      |

<br>

## **1 发送事件信号**

“审批结束” 动作可以作为一个**事件**，不同厂商的办公系统可能有不同的事件订阅方式（即信号发送）。

一般来说，厂商都会有对应的文档，也可以咨询他们的开发人员。例如致远OA的接口文档：[流程事件 · 致远开放平台](https://open.seeyon.com/book/ctp/bpmEvent.html#流程事件接口)

飞书则是有对应的平台，几乎可以做到一键配置：

[将事件发送至开发者服务器 - 服务端 API - 开发文档 - 飞书开放平台](https://open.feishu.cn/document/event-subscription-guide/event-subscriptions/event-subscription-configure-/choose-a-subscription-mode/send-notifications-to-developers-server) 

输入用户服务器地址就可以订阅接收，例如笔者的输入为：

```
http://Server_IP:PORT/api/event
```

收到的事件结构如下

```json
{
    "schema": "2.0",
    "header": { 
        "event_id": "f7984f25108f8137722bb63cee927e66",
        "token": "066zT6pS4QCbgj5Do145GfDbbagCHGgF",
        "create_time": "1603977298000000",
        "event_type": "contact.user_group.created_v3",
        "tenant_key": "xxxxxxx",
        "app_id": "cli_xxxxxxxx",
    },
    "event":{
        //结构体记录的是事件的详细信息，不同事件的信息不同
    }
}
```

[事件概述 - 服务端 API - 开发文档 - 飞书开放平台](https://open.feishu.cn/document/server-docs/event-subscription-guide/overview#d040d74d)

像这样的，当一个应用程序中发生某些特定事件（如用户注册、订单状态变更、新消息发布等），此应用会将这个事件的信息以HTTP请求的形式发送给预先设置好的一个URL的通信机制就是[Webhook](###Webhook)。



## **2 接收、处理事件**

对于非企业用户，可能会面临一个问题：

订阅飞书事件时没有公网地址，即无法被主动访问。幸好飞书推出了使用长连接接收模式，可以解决这个问题。这里笔者还是采用“将事件推送至开发者服务器”的模式。

笔者用**Django**的APIView为平台处理类似的事件：





## **4 自动化API调用**

笔者是一名网络工程师，这里以无线网络准入的例子举例：

> 公司入职的时候会一次性来很多小伙伴，每次手动添加白名单非常繁琐。于是可以通过流程的方式填入mac地址，审批结束后加入准入系统的白名单。





***

### Webhook

####  工作原理

1. **事件触发**：当一个应用程序发生某些特定事件（如用户注册、订单状态变更、新消息发布等），源应用会将这个事件的信息以HTTP请求的形式发送给预先设置好的一个URL。
2. **接收与处理**：这个URL指向的服务器接收到请求后，会根据请求中的数据执行相应的操作，比如更新数据库、发送通知、触发工作流等。

#### 特点

- **实时性**：Webhook 是一种“推”式通信机制，一旦事件发生，源应用会立即向目标应用发送通知。
- **轻量级**：Webhook 的实现相对简单，只需要一个HTTP服务器和一个可以接收HTTP请求的端点即可。
- **灵活性**：可以自定义发送给目标应用的数据格式和内容，目标也可以根据的需求对收到的数据进行处理。





























